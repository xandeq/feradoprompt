name: Backend - Build & FTP Deploy (.NET 8)

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
  workflow_dispatch:

concurrency:
  group: smarterasp-backend
  cancel-in-progress: false

permissions:
  contents: read

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore backend/FeraPrompt.Api/FeraPrompt.Api.csproj

      - name: Build
        run: dotnet build backend/FeraPrompt.Api/FeraPrompt.Api.csproj --configuration Release --no-restore

      - name: Publish
        run: dotnet publish backend/FeraPrompt.Api/FeraPrompt.Api.csproj --configuration Release --no-build --output ./publish

      # ============= 1) Criar app_offline.htm =============
      - name: Create app_offline.htm
        shell: bash
        run: |
          mkdir -p ./offline
          TS="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          cat > ./offline/app_offline.htm << EOF
          <!DOCTYPE html>
          <html lang="pt-BR"><head><meta charset="utf-8">
          <title>Atualizando...</title></head>
          <body style="font-family:Arial;display:grid;place-items:center;height:100vh">
            <div>
              <h2>Estamos publicando uma atualização</h2>
              <p>Tente novamente em instantes.</p>
              <small>deploy: ${TS}</small>
            </div>
          </body></html>
          EOF

      # ============= 2) Colocar app_offline no servidor =============
      - name: Put app_offline.htm
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.BACKEND_FTP_SERVER }}
          username: ${{ secrets.BACKEND_FTP_USER }}
          password: ${{ secrets.BACKEND_FTP_PASSWORD }}
          local-dir: ./offline/
          server-dir: ${{ secrets.BACKEND_FTP_PATH }}/
          state-name: .ftp-deploy-sync-state.offline.json
          log-level: standard

      # Tempo para IIS desligar o app
      - name: Wait IIS unload
        run: sleep 30

      # ============= 3) Deploy da aplicação publicada =============
      - name: FTP Deploy backend publish
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.BACKEND_FTP_SERVER }}
          username: ${{ secrets.BACKEND_FTP_USER }}
          password: ${{ secrets.BACKEND_FTP_PASSWORD }}
          local-dir: ./publish/
          server-dir: ${{ secrets.BACKEND_FTP_PATH }}/
          state-name: .ftp-deploy-sync-state.json
          log-level: standard
          exclude: |
            **/*.pdb
            **/*.xml
            **/*.md

      # ============= 4) Remover app_offline para subir o site =============
      - name: Remove app_offline.htm
        shell: bash
        run: |
          curl --silent --show-error --fail \
           --user "${{ secrets.BACKEND_FTP_USER }}:${{ secrets.BACKEND_FTP_PASSWORD }}" \
           --quote "DELE ${{ secrets.BACKEND_FTP_PATH }}/app_offline.htm" \
           "ftp://${{ secrets.BACKEND_FTP_SERVER }}/" || true
